```{r, echo=F}
library(data.table)
```

# Read & inspect data
```{r, cache=2}
ws_bucket <- Sys.getenv("WORKSPACE_BUCKET")
ws_bucket <- "gs://fc-secure-4a392455-5587-4d6f-b8bd-01a1f834ae63" # For local use
data_files <- c(C8=paste0(ws_bucket,"/metabolomics/raw/MESA_pilot_BroadInst_C8-pos_lipids_050517.csv"),
                HP=paste0(ws_bucket,"/metabolomics/raw/MESA_pilot_BroadInst_HIL-pos_polar_050517.csv"),
                AN=paste0(ws_bucket,"/metabolomics/raw/an_MESA_clean.txt"))

dts <- sapply( data_files, \(path) fread(cmd=paste("gsutil cat", path), header=F))

# Manually inspect the data and extract metabolite metadata.
dts$C8[1:8,1:8]
dts$HP[1:8,1:8]
dts$AN[1:8,1:8]
```
The data is in nonstandard format, so prepare for hardcoded row/col numbers!

# Extract metabolite metadata
Compound IDs may be duplicated across C8 and HP. A concatenated `<ID>_<Method>` variable ensures IDs are unique.\
Then, create a file mapping these IDs back to their metabolite metadata such as M/Z and RT.
```{r}
met_info <- list()
met_info$C8 <- dts$C8[seq(6,.N), 1:6]
met_info$HP <- dts$HP[seq(6,.N), 1:6]
met_info$AN <- data.table(method="Amine",
                          compound_id=paste0("an",2:ncol(dts$AN)),
                          mz=NA, rt=NA, hmdb_id=NA,
                          name=unlist(dts$AN[1,-1]))
names(met_info$C8) <- names(met_info$HP) <- names(met_info$AN)
met_info <- rbindlist(met_info)

met_info[met_info==' ' | met_info=='n/a'] <- NA

met_info[, unique_met_id := paste0(compound_id,"_",method)]
#sum(duplicated(met_info$unique_id)) # No dup IDs!

fwrite(met_info, "met_info.csv")
head(met_info)
```

# Extract sample metadata
Note: MESA AN file has no sample metadata, so it is ignored here. All its sample IDs are covered by C8 and HP methods anyways.
```{r}
sample_info <- list()
sample_info$C8 <- transpose(dts$C8[1:5, .SD, .SDcols=(7:ncol(dts$C8))])
sample_info$HP <- transpose(dts$HP[1:5, .SD, .SDcols=(7:ncol(dts$HP))])
names(sample_info[[1]]) <- names(sample_info[[2]]) <- c("extr_date","inject_date","column","analysis_order","sample_id")
sample_info <- merge(sample_info$C8, sample_info$HP, by="sample_id", suffixes=c("_c8","_hp"), all=T)

# Rm all-NA rows, an artifact from the raw files
sample_info <- sample_info[rowSums(!is.na(sample_info)) > 0]

sample_info[, is_control := !grepl("TOM",sample_id)]

write.csv(sample_info, "sample_info.csv")
head(sample_info)
```


# Extract measurement data
```{r}
dts$C8 <- dts$C8[, V6 := paste0(V2,"_",V1) ][, 1:5 := NULL ][-(1:4)]
dts$HP <- dts$HP[, V6 := paste0(V2,"_",V1) ][, 1:5 := NULL ][-(1:4)]
dts$AN <- data.table(t(dts$AN))[met_info, on=c(V1="name"), V1 := unique_met_id]

invisible(lapply(dts, set, i=1L, j=1L, "unique_met_id"))

invisible(mapply(dts, paste0(names(dts),"_cleaned.csv"), FUN=fwrite, col.names=F))
dts$C8[1:8,1:8]
dts$HP[1:8,1:8]
dts$AN[1:8,1:8]
```
