# Lib
```{r}
options(stringsAsFactors=FALSE)
library(data.table)
"%ni%" <- Negate("%in%")
```

# MESA C8 and HILIC positive
Amines data looks completely different, handled later.
```{r}
data_files <- c(MESA_C8=paste0("gs://fc-secure-4a392455-5587-4d6f-b8bd-01a1f834ae63/metabolomics/raw/MESA_pilot_BroadInst_C8-pos_lipids_050517.csv"),
                MESA_HP=paste0("gs://fc-secure-4a392455-5587-4d6f-b8bd-01a1f834ae63/metabolomics/raw/MESA_pilot_BroadInst_HIL-pos_polar_050517.csv"))
dts <- sapply( data_files, \(path) fread(cmd=paste("gsutil cat",path)) )

#dts[[1]][1:10,1:10] # Uncomment to get an idea of what the data looks like
```

```{r}
data_start_row <- 6
data_start_col <- 7

# Sample-related stuff all starts @ data_start_COL
sample_id_row <- 5
extr_date_row <- 1

# Metabolite-related stuff all starts @ data_start_ROW
invisible(lapply(dts, setnames, old=c("V1","V2","V3","V4","V5","V6"), new=c("method","compound_id","mz","rt","hmdb","name")))
```

## Remove '\*' suffix from some HMDBs
E.g. "HMDB00001*" --> "HMDB00001"
```{r}
invisible(lapply(dts, \(dt) dt[, hmdb := sub("\\*$","",hmdb) ] ))
```

## Deal with duplications in each LC-MS method
### Duplicated HMDBs
Remove `redundant_ion`s and `Internal Standard`s. Set `""` and `"n/a"` to `NA`.
```{r}
lapply(dts, \(dt) { tmp <- table(dt[,hmdb]); tmp[tmp>1] })
dts <- lapply(dts, \(dt) dt[hmdb %ni% c("redundant_ion","Internal Standard")] )
invisible(lapply(dts, \(dt) dt[hmdb %in% c("","n/a"), hmdb := NA] ))
```

#### MESA HILIC+ Duplicated HMDBs
```{r}
dup_hmdbs <- c("HMDB00853","HMDB00991","HMDB01325","HMDB07973","HMDB12101","HMDB13122")
dts[[2]][hmdb %in% dup_hmdbs, 1:6]

# TODO:
# Move the '*' removal to below
# For duplicated HMDBs where one is only a representative (has an asterisk), prefer the exact match.
# Otherwise, keep the first entry (arbitrary choice).
# TODO

# For most, just arbitrarily keep the first entry.
# For HMDB12101, keep the 2nd, becuase the 1st entry used to have an HMDB with an asterisk* (meaning it is a representative metabolite). We would rather have the exact metabolite. 
dts[[2]][ which(hmdb=="HMDB00853")[2] ][,1:10]
dts[[2]] <- dts[[2]][ which(hmdb=="HMDB00853")[2] ]
dts[[2]] <- dts[[2]][ which(hmdb=="HMDB00991")[2] ]
dts[[2]] <- dts[[2]][ -which(hmdb=="HMDB01325")[2] ]
dts[[2]] <- dts[[2]][ -which(hmdb=="HMDB07973")[2] ]
dts[[2]] <- dts[[2]][ -which(hmdb=="HMDB12101")[1] ]
dts[[2]] <- dts[[2]][ -which(hmdb=="HMDB13122")[2] ]
dts[[2]][hmdb %in% dup_hmdbs, 1:6]
```

### Duplicated Metabolite Names
```{r}
lapply(dts, \(dt) { tmp <- table(dt[,name]); tmp[tmp>1] })

# TMP
dts[[2]][grepl("C34:1|C34:2 DAG_or_TAG",name),][,1:10]
cor(as.numeric(tmp2[2,7:2110]),as.numeric(tmp2[4,7:2110]), use="complete.obs")
cor(as.numeric(tmp2[1,7:2110]),as.numeric(tmp2[3,7:2110]), use="complete.obs")
```

####  MESA HILIC+ Duplicated Names
```{r}
dup_nms <- c("C34:1 DAG_or_TAG_fragment", "C34:2 DAG_or_TAG_fragment")
dts[[2]][name %in% dup_nms, 1:6]
dts[[2]] <- dts[[2]][ name %ni% dup_nms ] # Just remove all 4 of these
```

### Duplicated Compound Ids and Sample Ids (there are none!)
```{r}
lapply(dts, \(dt) { tmp <- table(dt[, compound_id ]); tmp[tmp>1] })
lapply(dts, \(dt) { tmp <- table(dt[sample_id_row,]); tmp[tmp>1] })
```

## Checking for within-cohort Duplications?
Yes they exist, i.e. multiple methods (C8+, HILIC+) can pick up the same mets. A greater number than we'd want to remove.\
To deal with this, we will add a suffix signifying the method to the end of each HMDB later.
```{r}
all_mesa_hmdbs <- unlist(sapply(dts,'[',j=hmdb))
tmp <- table(all_mesa_hmdbs); tmp[tmp>1]
```



## Clean
Just the sample IDs as rows, metabolite compound IDs as columns, and measurement data in the middle.\
The dictionaries we made map these sample/metabolite IDs to the additional information if we ever need it later.
```{r}
sample_idss <- lapply(dts, \(dt)unlist(dt[sample_id_row, data_start_col:ncol(dt)]))

# Use compound id w/ method suffix, but for amines must use HMDB id.
met_idss <- lapply(seq_along(dts1), function(i) {
    tmp <- if(is.na(compound_id_cols[i])) {unlist( dts1[[i]][data_start_rows[i]:nrow(dts1[[i]]), hmdb_id_cols[i]    , with=F] )                      }
           else                    {paste0(unlist( dts1[[i]][data_start_rows[i]:nrow(dts1[[i]]), compound_id_cols[i], with=F] ), '_',dts1_methods[i])}
    tmp[duplicated(tmp)] <- paste0(tmp[duplicated(tmp)], "_dup") # If an ID is repeated
    return(tmp)
})
```

```{r}
paste("Original total size:", object.size(dts) / 10^9, "GB")

dts_clean <- list()
for(i in seq_along(dts1)) {
    dts1_clean[[i]] <- dts1[[i]][data_start_rows[i]:nrow(dts1[[i]]),
                                 data_start_cols[i]:ncol(dts1[[i]])]

    # Now data is numbers only, convert to numeric to save memory
      # (but not integer, b/c some counts are > MAX_INT and also amine measurements are floats)
    for(col in 1:ncol(dts1_clean[[i]])) set(dts1_clean[[i]], j=col, value=as.numeric(dts1_clean[[i]][[col]]))

    # T, and naming
    dts1_clean[[i]] <- t(dts1_clean[[i]])

    #rownames(dts1_clean[[i]]) <- sample_idss[[i]]
    colnames(dts1_clean[[i]]) <- met_idss[[i]]
    dts1_clean[[i]] <- data.table(sample_id=sample_idss[[i]], dts1_clean[[i]])
}

# c8_MESA has 4 full NA rows at the end (who knows why): all(is.na(tail(dts1_clean[[9]],n=4))) --> TRUE
dts1_clean[[9]] <- dts1_clean[[9]][!is.na(sample_id)]


names(dts1_clean) <- names(dts1)#; rm(dts1)
paste("Cleaned DTs total size:", object.size(dts1_clean) / 10^9, "GB")
```

```{r}
lapply(dts1_clean, dim)
# lapply(dts1_clean, tail, n=5)
lapply(dts1_clean, function(dt) grep("_dup", colnames(dt))) # Check where duplicates are (should be none)
```

## Write
```{r}
dir.create(file.path("PH_files"), showWarnings=F)
dir.create(file.path("PH_files/cleaned"), showWarnings=F)
for(i in seq_along(dts1_clean)) { write.table(dts1_clean[[i]], paste0("PH_files/cleaned/",names(dts1_clean)[i],"_clean.txt"), row.names=F) }
system(paste("gsutil cp -R PH_files $WORKSPACE_BUCKET"))
```

## MESA amines
```{r}
# TODO: load it in
colnames(dts2[[i]])[1] <- "sample_id"
```

## Write
```{r}
#dir.create(file.path("PH_files/cleaned/")) # Already done for dts1
for(i in seq_along(dts2)) {write.table(dts2[[i]], paste0("PH_files/cleaned/",names(dts2)[i],"_clean.txt"), row.names=F) }
```

```{r}
ws_bucket <- Sys.getenv('WORKSPACE_BUCKET')
system(paste("gsutil cp -R PH_files", ws_bucket))
```

```{r}
#dts1[["an_WHI"]]
tmp <- unlist(dts1[["an_WHI"]][,5])
table(nchar(tmp))
as.data.frame(dts1[["an_WHI"]])[nchar(tmp)==0,]
```

# Make Maps/Dictonaries
## Sample-batch map
```{r}
extr_datess <- lapply(seq_along(dts1), function(i) unlist(dts1[[i]][ extr_date_rows[i], data_start_cols[i]:ncol(dts1[[i]]) ]))
sample_idss <- lapply(seq_along(dts1), function(i) unlist(dts1[[i]][ sample_id_rows[i], data_start_cols[i]:ncol(dts1[[i]]) ]))
unique_ids <- unique(unlist(sample_idss))
                                                                               # v sample id & cohort cols
sample_info <- data.table(matrix( "", nrow=length(unique_ids), ncol=length(dts1)+2 ))
colnames(sample_info) <- c("sample_id", "cohort", paste0(names(dts1),"_batch"))
sample_info$sample_id <- unique_ids

for(i in seq_along(extr_datess     )) {
for(j in seq_along(extr_datess[[i]])) {
    sample_info[sample_id==sample_idss[[i]][j], i+2] <- extr_datess[[i]][j]
    sample_info[sample_id==sample_idss[[i]][j],   2] <- if(i%in%1:4) {"FHS"}
                                                   else if(i%in%5:8) {"WHI"}
                                                   else if(i%in%9:10){"MESA"}
}}
sample_info[, 3:12 := lapply(.SD, as.factor), .SDcols=3:12] # Convert those batch columns to factors
# Note: careful about the empty "" entries. You should select one cohort at a time to avoid them.

sample_info[, is_control := !grepl("TOM",sample_id)]
sample_info <- sample_info[!is.na(sample_info$sample_id)]
rm(extr_datess, unique_ids)
```

```{r}
sample_info[runif(10,1,nrow(sample_info))] # Random selection of 10 rows
```

## Metabolite Info Map
### Get Metabolite Info Maps from each Cohort
```{r}
# Convenience fn
selectMetInfoCols  <- function(dts, col_inds)
    lapply(seq_along(dts), function(i) {
        if(is.na(col_inds[i])) { rep(NA,times=nrow(dts[[i]])-data_start_rows[i]+1) }
        else                   { dts[[i]][data_start_rows[i]:nrow(dts[[i]]), col_inds[i], with=F] }
})

met_info_mesa <- data.table(
    Compound_Id_MESA= unlist(selectMetInfoCols(dts1[9:10], compound_id_cols[9:10])) ,
    HMDB_Id     = unlist(selectMetInfoCols(dts1[9:10],         hmdb_id_cols[9:10])) ,
    Name        = unlist(selectMetInfoCols(dts1[9:10],        met_name_cols[9:10])) ,
    MRM         = unlist(selectMetInfoCols(dts1[9:10],             mrm_cols[9:10])) ,
    MZ          = as.numeric(unlist(selectMetInfoCols(dts1[9:10],   mz_cols[9:10]))),
    RT          = as.numeric(unlist(selectMetInfoCols(dts1[9:10],   rt_cols[9:10]))),
    Method      = unlist(selectMetInfoCols(dts1[9:10],          method_cols[9:10])) )
```

```{r}
met_info_mesa[met_info_mesa==""] <- NA
met_info_mesa[grepl("tandard",HMDB_Id), HMDB_Id:=NA]
met_info_mesa[met_info_mesa=="n/a"] <- NA
```

```{r}
met_info_mesa[runif(5,1,nrow(met_info_mesa))]# Inspect 5 random rows
```

### Add MESA amines to met_info_mesa
Used [MetaboAnalyst webtool](https://www.metaboanalyst.ca/MetaboAnalyst/upload/ConvertView.xhtml) to match the colnames of amines_MESA to HMDB ids, with some manual work (not in code). The result was the file "MESA_amines_HMDBs.csv" loaded here.
```{r}
mesa_amines_info <- read.csv("MESA_amines_HMDBs.csv")
head(mesa_amines_info)
# Manually inpsect and ensure the names are aligned, so can just cbind
# cbind(colnames(dts2[["amines_MESA"]])[-1], mesa_amines_info) # Yes

to_rbind <- data.table(
    Compound_Id_MESA= sub("_an","", colnames(dts2[["an_MESA"]])[-1]),
    HMDB_Id     = mesa_amines_info$HMDB,
    Name        = mesa_amines_info$Match,
    MZ          = NA,
    MRM         = NA,
    RT          = NA,
    Method      = "Amide-Negative-sMRM")
met_info_mesa <- rbind(met_info_mesa, to_rbind)
```

### Standardize amount of 0s in padding of HMDBs
MESA C8-pos and HIL-pos have 2 fewer 0s in the padding of their HMDB ids than the other datasets. E.g. HMDB02815 instead of HMDB0002815.\
Standardizing these HMDBs to be 11 chars long like the rest of the data.
```{r}
met_info_mesa[nchar(HMDB_Id)!=11, HMDB_Id := sub("HMDB","HMDB00", HMDB_Id)]
```

```{r}
met_info_mesa[runif(5,1,nrow(met_info_mesa))] # Inspect 5 random rows
```

### Aligning Knowns: 1st Pass
Merging knowns across cohorts where the `<HMDB>_<method>` matches _exactly_ (both HMDB and method). If there is such a match, it is guaranteed to be the only one since we manually removed all duplications from each individual method dataset.
#### Add method suffix
Add a suffix to the compound id depending on method; otherwise the ids may not be unique.
```{r}
addMethodSuffix <- function(compound_id_vec, method_vec) {
    sapply(1:length(compound_id_vec), function(i) {
        if(is.na(compound_id_vec[i])) return(NA)
        if(is.na(method_vec[i])) return(compound_id_vec[i])

        if(method_vec[i]=="C8-pos"   ) return(paste0(compound_id_vec[i],"_cp"))
        if(method_vec[i]=="C18-neg"  ) return(paste0(compound_id_vec[i],"_cn"))
        if(method_vec[i]=="HIL-pos"  ) return(paste0(compound_id_vec[i],"_hp"))
        if(method_vec[i]=="HILIC-pos") return(paste0(compound_id_vec[i],"_hp"))
        if(method_vec[i]=="Amide-Negative-sMRM") return(paste0(compound_id_vec[i],"_an"))
})}

met_info_mesa$Compound_Id_MESA <- addMethodSuffix(met_info_mesa$Compound_Id_MESA, met_info_mesa$Method)
met_info_mesa$HMDB_Id          <- addMethodSuffix(met_info_mesa$HMDB_Id,          met_info_mesa$Method)
```

Additionally, change bulky (and inconsistent in the case of HILIC+) method names in the Method column.
```{r}
renameMethods <- function(method_vec) {
  ifelse(method_vec=="C8-pos", "cp",
  ifelse(method_vec=="C18-neg", "cn",
  ifelse(method_vec=="Amide-Negative-sMRM", "an",
  ifelse(method_vec=="HIL-pos" | method_vec=="HILIC-pos", "hp", NA))))
}

met_info_mesa$Method <- renameMethods(met_info_mesa$Method)
table(met_info_mesa$Method) # Inspect
```

```{r}
nrow(met_info_knowns)
met_info_knowns[runif(5,1,nrow(met_info_knowns)),] # Inspect 5 random rows
```

# DELETED myFn which was a 2nd pass aligning knowns, ignoring if the knowns had different methods (which didn't matter a/w b/c there were no additional imperfect matches to collect after perfect matching is done.
# TMP NOTE: Made a big deletion of old code here

```{r}
met_info <- rbind(met_info_knowns, met_info_aligned_unknowns)
dim(met_info); head(met_info); tail(met_info)
```

#### Add the rest of (unaligned) unknowns to met_info
Making sure not to duplicate unknowns which are already in met_info
```{r}
met_info_mesa2 <- met_info_mesa[Compound_Id_MESA %!in% met_info$Compound_Id_MESA,]
met_info <- rbind(met_info, met_info_fhs2, met_info_whi2, met_info_mesa2)
dim(met_info); head(met_info); tail(met_info)
```

#### Inspect random rows
```{r}
met_info[runif(10,1,nrow(met_info))] # Random selection of 10 rows
table(met_info$Method)
```

## Write
```{r}
dir.create("PH_files", showWarnings=F)
write.csv(sample_info, "PH_files/sample_info.csv",  row.names=F)
write.csv(met_info,    "PH_files/met_info_v12.csv", row.names=F)
system(paste("gsutil cp -R PH_files $WORKSPACE_BUCKET"))
```
