---
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
---
```{css echo=F}
pre { overflow-x: scroll; }
pre code { white-space: pre; }
```

# Setup
```{r}
library(data.table)

if (!require('picsure', quiet=T)) {
  Sys.setenv(TAR = if(Sys.info()['sysname']=='Windows') 'C:/WINDOWS/system32/tar' else '/bin/tar')
  options(unzip = 'internal')
  remotes::install_github(
    repo = 'hms-dbmi/pic-sure-r-adapter-hpds',
    ref  = 'main', force=T
  )
}
```
```{r}
picsure_url = 'https://picsure.biodatacatalyst.nhlbi.nih.gov/picsure'
token <- scan('picsure_token.txt', what='character', quiet=T)
session <- picsure::bdc.initializeSession(picsure_url, token) |> picsure::bdc.setResource('AUTH')
```

# Search variables
## Get search objects
This is analogous to exploring variables in the PIC-SURE web UI.
```{r}
# For some reason, query wait time scales with `limit`, so set as low as possible while still getting all variables.
t0 <- Sys.time()

mesa_ids_search <- picsure::bdc.searchPicsure(session, 'phs001416',               limit=  200) |> setDT()
    mesa_search <- picsure::bdc.searchPicsure(session, 'phs000209',               limit=25000) |> setDT()
     fhs_search <- picsure::bdc.searchPicsure(session, 'phs000974',               limit= 2000) |> setDT()
  topmed_search <- picsure::bdc.searchPicsure(session, 'DCC Harmonized data set', limit=  500) |> setDT()

# I don't have access to phs000007 (Kenny has to do it for me), so I don't know how small I can set `limit` before variables start getting dropped.
#search_results <- picsure::bdc.searchPicsure(session)
#saveRDS(search_results, 'search_results.rds')
system('gcloud storage cp gs://fc-secure-4a392455-5587-4d6f-b8bd-01a1f834ae63/notebooks/search_results.rds .')
phs000007_search <- readRDS('search_results.rds') |> setDT()
# Update: Kenny provided query results in 'phs000007_query.rds', accessed below.

Sys.time() - t0
```

## Narrow down desired variables
### TOPMed harmonized variables
```{r}
tmp <- topmed_search[,-'name'][, var_description := gsub('\n',' ',var_description)] # For manual viewing in VisiData

topmed_vars <- topmed_search[
  ][grepl(
      x   = tolower(paste(var_id, var_name, var_description)),
      pat = paste(collapse='|', c(
        'lipid_lowering_medication',
        'fasting_lipids', #(This is an indicator var of whether they fasted >=8hr b4 lipid measures or not)
        'hdl',
        'triglycerides',
        'bmi_baseline', # 'Body mass index calculated at baseline.'
        'ever_smoker_baseline',
        'current_smoker_baseline',
        'sleep_duration',
        'race_us',
        'subcohort', # 'A distinct subgroup within a study, generally indicating subjects who share similar characteristics due to study design. Subjects may belong to only one subcohort.'
        'hispanic_or_latino',
        'geographic_site',
        'annotated_sex',
        'age_at_hdl', 'age_at_triglycerides', 'age_at_ever_smoker', 'age_at_current_smoker', 'age_at_fasting_lipids', 'age_at_lipid_lowering', 'age_at_sleep'
    )))
]
```

### FHS (phs000007) search
```{r}
tmp <- phs000007_search[,-'name'][study_id=='phs000007'] # For manual viewing

phs000007_vars <- phs000007_search[
  ][study_id=='phs000007'
  ][grepl(
      x   = tolower(paste(var_id, var_name, var_description)),
      pat = paste(collapse='|', c(
        'shareid',
        'sex',
        'age',
        'bmi',
        'smoking',
        'mvpa',
        'hdl',
        'lipid_med',
        'race'
    )))
]
```


### FHS (phs000974) search
```{r}
tmp <- fhs_search[,-'name'][, var_description := gsub('\n',' ',var_description)] # For manual viewing

fhs_vars <- fhs_search[
  ][grepl(
      x   = var_name,
      pat = paste(collapse='|', c(
        'Age_at_collection', # There's multiple
        'AGE_OF_COLLECTION',
        'Batch',
        'Collection_visit', # There's multiple
        'extractDate',
        'IS_TUMOR', # all are "no"
        'SEX',
        'SAMPLE_ID',
        'PlateId', 'Sample_well_ID', 'Sample_container_ID',
        'SUBJECT_ID'
    )))
]
```

### MESA search
```{r}
tmp <- mesa_search[,-'name'][, var_description := gsub('\n',' ',var_description)] # For manual viewing

mesa_vars <- mesa_search[
  ][grepl(
      x   = group_name,
      pat = paste(collapse='|', c(
        'MESA_Exam[0-9]Main',
        'MESA_AncilMesaMineralMetabolite',        # nac
        'MESA_AncilMesaNeighborScalesExam',       # ahei_2010
        'MESA_AncilMesaNeighborScalesSodiumExam', # dash_sodium
        'MESA_exam[0-9]dietnutrients',            # nan
        'MESA_AncilMesaNeighborSESExam'           # F1_PC2
    )))
  ][grepl(
      x   = var_name,
      pat = paste(collapse='|', c(
        'sidno',
        '^age[0-9]c$',
        'ahei',
        'alc',
        'bmi[0-9]c',
        'cig[0-9]c',
        'dash_sodium',
        'F1_PC2',
        'gender',
        'glucos[0-9]c',
        'hba',
        'hdl[0-9]$',
        'income',
        'ins[0-9]c',
        'lipid',
        'month',
        'nac',
        'nan[0-9]c',
        'race1c',
        'season',
        'site[0-9]c',
        'exercm[0-9]c', 'pamcm[0-9]c', 'pavcm[0-9]c', 'pamvcm[0-9]c'
    )))
  #][, unique(group_name)
  #][grep('sidno', var_name)
]
```
```{r}
tmp <- mesa_ids_search[,-'name']

mesa_id_vars <- mesa_ids_search[
  ][grepl(
      x   = group_name,
      pat = paste(collapse='|', c(
      'TOPMed_MESA_Sample',
      'TOPMed_MESA_Subject',
      'TOPMed_MESA_Metabolomics'
    )))
]
```


# Query
Now we actually request the individual-level data for the desired variables with a query:
```{r}
do_query <- \(varnames) bdc.newQuery(session) |> addClause(keys=varnames, type='ANYOF') |> runQuery(resultType='DATA_FRAME') |> setDT()

fwrite(phs000007_query, 'test.csv')
#phs000007_query <- do_query(phs000007_vars$name)
system('gcloud storage cp gs://fc-secure-4a392455-5587-4d6f-b8bd-01a1f834ae63/notebooks/phs000007_query.rds .')
phs000007_query <- readRDS('phs000007_query.rds')
mesa_query      <- do_query(     mesa_vars$name)
mesa_id_query   <- do_query(  mesa_id_vars$name)
fhs_query       <- do_query(      fhs_vars$name)
topmed_query    <- do_query(   topmed_vars$name)
```


# Format phs000007 query results
For some reason, there is no `RACE_CODE` in the query result object despite Kenny pulling all variables. But anyway, FHS is mostly white, so we will skip that covariate. \
There is no site/center/location variable, so we will skip that as well. \
There are many "drinks per week"-ish variables, but they don't exactly match ("drinks per week" vs. "times drank per week"), so I will omit this covariate to save time harmonizing.
```{r}
phs000007_query[phs000007_query==''] <- NA # Otherwise '' will mess with fcoalesce
phs000007_query <- phs000007_query[
  ][, age := fcoalesce(
        `\\phs000007\\pht006026\\phv00277020\\AGE1\\`, # Gen3
        `\\phs000007\\pht009761\\phv00544734\\age5\\`) # Offspring
  ][, SEX := fcoalesce(
        `\\phs000007\\pht006026\\phv00277017\\SEX\\`, # Gen3
        `\\phs000007\\pht009761\\phv00423870\\SEX\\`) # Offspring
  ][, HDL := fcoalesce(
        `\\phs000007\\pht006026\\phv00277040\\HDL1\\`, # Gen3
        `\\phs000007\\pht009761\\phv00544810\\HDL5\\`) # Offspring
  ][, smoking := fcoalesce(
        `\\phs000007\\pht006026\\phv00277032\\CURRSMK1\\`, # Gen3
        `\\phs000007\\pht009761\\phv00544778\\currsmk5\\`) # Offspring
  ][, .SD, .SDcols = patterns(paste(collapse='|', c(
      '^age$', '^SEX$', '^HDL$', '^smoking$',
      'patient_id', 'Study Accession')))
] |> setnames(\(nm)  sub('.*\\\\(.*)\\\\$', '\\1', nm))
```


# Deal with duplicate columns in FHS (phs000974)
FHS has many columns with duplicate names and their distinction is not clear from the PIC-SURE `variable_description`s. We must manually [look up their phv #s in dbGap](https://dbgap.ncbi.nlm.nih.gov/beta/search/) or in some cases infer by exploring the data ourselves. \
Strategy: I subset to sets of same-name columns, manually explored the data in VisiData, and then added R snippets after the fact to demonstrate any interesting properties/differences I discovered.

### `SUBJECT_ID`
There are 3 `SUBJECT_ID` cols. A dbGaP search of their phv #s reveals no useful info to distinguish them. \
The 3 columns are identical, except the 2nd one has 8 NAs in it, and the 3rd one has 6407 NAs in it. \
In short, the 1st column has the most complete information and is in fact a superset of the other two, so just use that one (phv00252386).
```{r}
tmp <- fhs_query[, .SD, .SDcols=patterns('SUBJECT_ID')
] |> setnames(\(nm)  sub('.*\\\\(.*)\\\\$', '\\1', nm)) # For manual viewing

tmp[, sapply(.SD,\(x)sum(is.na(x)))] # Count NAs

# Showing the non-NA ids in cols 2&3 are identical to the complete col 1.
tmp[complete.cases(tmp[,c(1,2)]), identical(.SD[[1]],.SD[[2]])] # TRUE
tmp[complete.cases(tmp[,c(1,3)]), identical(.SD[[1]],.SD[[3]])] # FALSE!?
tmp[complete.cases(tmp[,c(1,3)]), identical(.SD[[1]],as.integer(.SD[[3]]))] # Oh, just integer vs. numeric
```

### `IS_TUMOR`
There are 4 `IS_TUMOR` columns. \
They all have missing data in diffierent places. Probably refer to different omics. \
But nothing is a tumor sample anyway, so forget about it.
```{r}
tmp <- fhs_query[, .SD, .SDcols=patterns('IS_TUMOR')
] |> setnames(\(nm)  sub('.*\\\\(.*)\\\\$', '\\1', nm)) # For manual viewing

tmp[, sapply(.SD,table)] # Always "no" or NA.
```

### `Collection_visit`
There are 4 Collection_visit columns. \
A dbGaP search reveals [phv00543910](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00543910) and [phv00543919](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00543919) are the metabolomics ones we want. \
Why are there two metabolomics ones? Dunno. But the two columns do not have any conflicts, we can can coalesce them.
```{r}
tmp <- fhs_query[, .SD, .SDcols=patterns('Collection_visit')
] |> setnames(\(nm)  sub('.*\\\\(.*)\\\\$', '\\1', nm)) # For manual viewing

# All 4 cols are almost perfectly coalesce-able, except 12 people with a mismatching visit "1" and "2".
# The phv00543910 and phv00543919 are the metabolomics ones. Thankfully no mismatches b/t those two.
tmp[sample(1:.N,5)] # 5 random rows
tmp[, .SD[ .SD[[1]]!=.SD[[4]] ]] # mismatches
tmp[, .SD[ .SD[[3]]!=.SD[[4]] ]] # But no mismatches b/t the two metabolomics ones, phew.
```

### `Sample_container_ID` & `Sample_well_ID`
There are 2 of each. \
These containers must refer to different omics. If you search up the dbGaP phv #s, you can see. \
The 1st col ("RAMA___ containers") is [phv00500015](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00500015), methylomics. The 2nd col (plain-numbered) is [phv00543928](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00543928), metabolomics.
```{r}
tmp <- fhs_query[, .SD, .SDcols=patterns('Sample_container_ID|Sample_well_ID')
] |> setnames(\(nm)  sub('.*\\\\(.*)\\\\$', '\\1', nm)) # For manual viewing

tmp[sample(1:.N,9)] # 9 random rows
```

#### `PlateId` & `Batch` & `extractDate`
There's also `PlateId` ([phv00498670](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00498670)) and `Batch` ([phv00543896](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00543896)) & `extractDate` ([phv00543899](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00543899)), but those are for proteomics/methylomics/methylomics.

### `Age_at_collection` & `AGE_OF_COLLECTION`
There are 4 of these columns total. \

* [phv00500009](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00500015) -- Methylomics
* [phv00543906](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00543906) -- RNASeq
* [phv00543908](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00543908) -- Metabolomics
* [phv00543917](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00543917) -- Metabolomics also

Below simply confirms that the ages of the two metabolomics columns have no conflicts.
```{r}
tmp <- fhs_query[, .SD, .SDcols=patterns('AGE_OF_COLLECTION|Age_at_collection')
] |> setnames(\(nm)  sub('.*\\\\(.*)\\\\$', '\\1', nm))
# (Manually confirmed there are no conflicts between the two metabolomics columns externally in VisiData and I'm lazy to add demonstrative code here.)
```

### `SAMPLE_ID`
There are 6 `SAMPLE_ID` columns. \
The first column is simplly all the other columns concatenated with tabs. The others are NWD (phv00252391), TOE (phv00499999), TOR (phv00500017), TOM(phv00543907), and TOM(phv00543916) (--yes, there are two TOM ones). \
The two TOM ones have no conflicts, so I will just coalesce them, I guess. \

There are also 9 people with 2 or more tab-separated NWD ids. It is not clear which is the preferred one, so I will arbitrarily take the first. It is not enough samples to warrant the merging complications that would arise from trying to consider them all.
```{r}
tmp <- fhs_query[, .SD, .SDcols=patterns('SAMPLE_ID')
][, names(.SD) := lapply(.SD, \(x) gsub('\t',' ',x))
] |> setnames(\(nm)  sub('.*\\\\(.*)\\\\$', '\\1', nm)) # For manual viewing

tmp[, .SD[[2]][grepl(' ',.SD[[2]])]] # Those with multiple NWD ids

tmp[sample(1:.N,9)] # 9 random rows
```

## Putting all of this together to tidy the FHS variables
In conclusion since we are only interested in metabolomics this is what we'll do: \

* `SEX`: Keep
* `SUBJECT_ID`: Keep only the phv00252386 one
* `IS_TUMOR` & `PlateId` & `Batch`: Drop
* `Collection_visit`: Coalesce [phv00543910](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00543910) & [phv00543919](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00543919)
* `Age_at_collection`: Coalesce [phv00543908](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00543908) & [phv00543917](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00543917)
* `SAMPLE_ID`: Coalesce [phv00543907](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00543907) & [phv00543916](https://dbgap.ncbi.nlm.nih.gov/beta/search/?OBJ=variable&TERM=phv00543916)
```{r}
fhs_query[fhs_query==''] <- NA # Otherwise '' will mess with fcoalesce
fhs_query <- fhs_query[
  ][, metabolomics_age := fcoalesce(
        `\\phs000974\\pht015035\\phv00543908\\Age_at_collection\\`, 
        `\\phs000974\\pht015036\\phv00543917\\Age_at_collection\\`)
  ][, metabolomics_visit := fcoalesce(
        `\\phs000974\\pht015035\\phv00543910\\Collection_visit\\`,
        `\\phs000974\\pht015036\\phv00543919\\Collection_visit\\`)
  ][, TOM_Id := fcoalesce(
        `\\phs000974\\pht015035\\phv00543907\\SAMPLE_ID\\`,
        `\\phs000974\\pht015036\\phv00543916\\SAMPLE_ID\\`)
  ][, NWD_Id := sub('\t.*','', `\\phs000974\\pht004911\\phv00252391\\SAMPLE_ID\\`) # Keep only the 1st if multiple tab-delimited NWD ids.
  ][, .SD, .SDcols = patterns(paste(collapse='|', c(
    'SEX', 'patient_id', 'Study Accession',
    'phv00252386', # SUBJECT_ID
    'metabolomics_age', 'metabolomics_visit', 'NWD_Id', 'TOM_Id')))
] |> setnames(\(nm)  sub('.*\\\\(.*)\\\\$', '\\1', nm))
```

# Merge with TOPMed-wide variables
```{r}
topmed_query |> setnames(\(nm)  sub('.*\\\\(.*)\\\\$', '\\1', nm))
tmp <- topmed_query[grepl('FHS',subcohort_1)]

fhs_full <- phs000007_query[
  ][fhs_query,
    on=.(`_Topmed Study Accession with Subject ID`,
         `_Parent Study Accession with Subject ID`,
         patient_id, SEX)
]

# To compare with TOPMed-harmonized variables if desired:
#fhs_full <- topmed_query[
#  ][, .SD, .SDcols=!patterns('^unit_|_consents') # Don't need these cols...
#  ][phs000007_query,
#    on=.(`_Topmed Study Accession with Subject ID`,
#         `_Parent Study Accession with Subject ID`,
#         patient_id,
#         annotated_sex_1=SEX)
#  ][fhs_query,
#    on=.(`_Topmed Study Accession with Subject ID`,
#         `_Parent Study Accession with Subject ID`,
#         patient_id,
#         annotated_sex_1=SEX)
#]
```


# Write
```{r}
dir.create('data/derived/phenotypes', rec=T)
#fwrite(phs000007_query, 'data/derived/phenotypes/phs000007_picsure_variables.csv')
fwrite(mesa_query,      'data/derived/phenotypes/mesa_picsure_variables.csv')
fwrite(mesa_id_query,   'data/derived_phenotypes/mesa_id_picsure_variables.csv')
fwrite(fhs_full,        'data/derived/phenotypes/fhs_picsure_variables.csv')
fwrite(topmed_query,    'data/derived/phenotypes/topmed_picsure_variables.csv')
```


```{r}
nwds <- fhs_query[!is.na(TOM_Id) & !is.na(NWD_Id), NWD_Id]
sum(nwds %in% dosages$NWD_Id)
dosages[dosages$NWD_Id %in% nwds, table(chr14_88305056_G_A)]
```
