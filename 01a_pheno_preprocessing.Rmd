# Set up
```{r}
library(tidyverse)
library(patchwork, table1)
```

## Build basic functions
Function to remove outliers by SD
```{r}
remove_outliers.fun <- function(x, SDs=5) {
    bounds <- mean(x, na.rm=T) + SDs * c(-1, 1) * sd(x, na.rm=T)
    print(paste0(sum(x < bounds[1], na.rm=TRUE), " outliers removed at <", SDs, " SDs"))
    print(paste0(sum(x > bounds[2], na.rm=TRUE), " outliers removed at >", SDs, " SDs"))
    x <- ifelse(x>bounds[1] & x<bounds[2], x, NA) ; x    
}
```

Functions for describing data
```{r}
# Print %s for categorical vars
n_pct <- function(x, level=F) {
  if(level==F) {
  sapply(as.list(names(table(x))), function(lvl) {
    paste0(lvl, ", ", sum(x == lvl, na.rm=T), " (", round(sum(x == lvl, na.rm=T)/n()*100,1), "%)") }) } 
  else{paste0(sum(x == level, na.rm=T), " (", round(sum(x == level, na.rm=T)/n()*100,1), "%)")}
}
```

# Read in and align PIC-SURE pheno datasets
```{r}
system(paste0("gsutil cp -R $WORKSPACE_BUCKET/phenotypes ."))
phenos_basic.df <- read_csv("phenotypes/mesa5_phenos_basic.csv", col_types=cols())
phenos_diet.df  <- read_csv("phenotypes/mesa5_phenos_diet.csv",  col_types=cols())
head(phenos_basic.df)
head(phenos_diet.df)
```

```{r}
# Remove front matter and trailing backslashes from MESA phenotype names
fix_pheno_names <- function(pheno_names) {
    new_pheno_names <- unlist(lapply(pheno_names, function(nm) {
        if (grepl("phs000209", nm)) {
            capture_str <- ".*\\\\(.*)\\\\$"
            nm <- str_match(nm, capture_str)[, 2]  # Extract real column name from front matter
            nm
        } else { nm }
    }))
    new_pheno_names
}
```

```{r}
# Basic demogrphic, behavioral & biomarker phenotypes
phenos_basic.df <- read_csv("phenotypes/mesa5_phenos_basic.csv", col_types=cols()) %>%
    rename_with(fix_pheno_names, everything()) %>%
    mutate(mesa_id = gsub("phs000209.v13_", "", 
                          `\\_Parent Study Accession with Subject ID\\`),
           mesa_id = as.integer(mesa_id)) %>%
    rename(Parent_Study_Accession='\\_Parent Study Accession with Subject ID\\',
           TopMed_Study_Accesssion='\\_Topmed Study Accession with Subject ID\\',
           consents='\\_consents\\') %>%
    rename(site=site5c, season=season5,
           age=age5c, age_cat=agecat5c, 
           gender=gender1, sex=SEX, racethn=race1c, 
           educ_lvl=educ1, educ_lvl_dad=dadschl2, educ_lvl_mom=momschl2,
           income_lvl=income5, income_hhld=numhhld5,
           smoke_stat=smkstat5, smoke_packyrs=pkyrs5c, 
           alch_currdrnk=curalc5, physact_mvpa=pamvcm5c,
           bmi=bmi5c, tg=trig5, ldl=ldl5, hdl=hdl5, 
           glucose=glucose5, hba1c=hba1c5,
           sbp=sbp5c, dbp=dbp5c,
           med_t2d=diabhx5, med_t2d_type=dbhxtyp5,
           med_lip=lipid5c, med_htn=htnmed5c,
           energy_kcal=enrgyn5c) %>%
    select(-c(Parent_Study_Accession, TopMed_Study_Accesssion, consents, 'Patient ID')) %>%
    select(-c(energy_kcal)) %>%
    as.data.frame()


## Recode categorical vars from CAPS to lowercase
phenos_basic.df <- phenos_basic.df %>% 
    mutate(across(c("gender", "educ_lvl", "educ_lvl_dad", "educ_lvl_mom", "income_lvl", "racethn", 
                    "season", "alch_currdrnk", "smoke_stat", "med_t2d", "med_htn", "med_lip"), tolower))

head(phenos_basic.df)
dim(phenos_basic.df)
```

Compare sex vs gender for missingness --> use gender
```{r}
print(phenos_basic.df %>% reframe(sex=n_pct(sex), gender=n_pct(gender)))

phenos_basic.df <- phenos_basic.df %>% 
    mutate(female=c(female=1, male=0)[gender], .before=educ_lvl) %>% 
    select(-sex)
```

Recode Race/Ethnicity labels
```{r}
phenos_basic.df <- phenos_basic.df %>% 
    mutate(RaceEthn = case_when(
        racethn == "white, caucasian" ~ "White",
        racethn == "black, african-american" ~ "African American",
        racethn == "hispanic" ~ "Hispanic",
        racethn == "chinese american" ~ "Chinese",
        is.na(racethn) == TRUE ~ "Missing")) %>%
    mutate(RaceEthn = factor(RaceEthn, levels = c("White", "African American", "Hispanic", "Chinese", "Missing")))

phenos_basic.df %>% reframe(RaceEthn=n_pct(RaceEthn))
```

Recode & add education variables
```{r}
phenos_basic.df <- phenos_basic.df %>%
    # Recode NA values as meanginful: Missing
    mutate(educ_lvl.lab = ifelse(is.na(educ_lvl), "Missing", educ_lvl)) %>%
    mutate(educ_lvl.lab = factor(educ_lvl.lab, levels = c("no schooling", "grades 1-8", "grades 9-11", 
                                                "completed high school/ged", "some college but no degree", 
                                                "technical school certificate","associate degree", 
                                                "bachelor's degree", "graduate or professional school", "Missing"),
                          labels=c("No school", "Grades 1-8", "Grades 9-11", "Completed HS/GED", 
                                  "Some college", "Technical school", "Associate's degree", 
                                   "Bachelor's degree", "Graduate or professional degree", "Missing"))) %>%
    
    mutate(educ_4lvl.lab = factor(
        case_when(
            educ_lvl.lab %in% c("No school", "Grades 1-8", "Grades 9-11") ~ "Less than HS",
            educ_lvl.lab == "Completed HS/GED" ~ "Graduated HS",
            educ_lvl.lab %in% c("Some college", "Technical school", "Associate's degree") ~ "Some college",
            educ_lvl.lab %in% c("Bachelor's degree", "Graduate or professional degree") ~ "Graduated college or more",
            as.numeric(NA) == TRUE ~ "Missing"))) %>%
    mutate(educ_4lvl.lab = factor(educ_4lvl.lab, levels = c("Less than HS", "Graduated HS", 
                                                            "Some college", "Graduated college or more", "Missing")) 
)

phenos_basic.df %>% reframe(Education_lvl=n_pct(educ_lvl.lab))
phenos_basic.df %>% reframe(Education_4lvl=n_pct(educ_4lvl.lab))
```

Recode & add income variables
```{r}
phenos_basic.df <- phenos_basic.df %>% 
    mutate(income_lvl.lab = ifelse(is.na(income_lvl), "Missing", income_lvl)) %>%
    mutate(
        income_lvl.lab = factor(
            income_lvl.lab, levels = c("< $5000", "$5000 - $7999", "$8000 - $11999", "$12000 - $15999", 
                                   "$16000 - $19999", "$20000 - $24999", "$25000 - $29999", "$30000 - $34999", 
                                   "$35000 - $39999", "$40000 - $49999", "$50000 - $74999", "$75000 - $99999", 
                                   "$100,000 - $124,999", "$125,000 - $149,999", "$150,000 or more", "Missing"),
                labels = c("Less than $5,000", "$5,000 - $7,999", "$8,000 - $11,999", "$12,000 - $15,999", 
                                   "$16,000 - $19,999", "$20,000 - $24,999", "$25,000 - $29,999", "$30,000 - $34,999", 
                                   "$35,000 - $39,999", "$40,000 - $49,999", "$50,000 - $74,999", "$75,000 - $99,999", 
                                   "$100,000 - $124,999", "$125,000 - $149,999", "$150,000 or more", "Missing")
            )) %>%
    mutate(
        income_4lvl.lab = factor(
            case_when(income_lvl.lab %in% c("Less than $5,000", "$5,000 - $7,999", "$8,000 - $11,999", "$12,000 - $15,999", 
                                   "$16,000 - $19,999", "$20,000 - $24,999") ~ "<$25000",
                      income_lvl.lab %in% c("$25,000 - $29,999", "$30,000 - $34,999", 
                                   "$35,000 - $39,999", "$40,000 - $49,999") ~ "$25,000-$49,000",
                      income_lvl.lab %in% c("$50,000 - $74,999", "$75,000 - $99,999") ~ "$50,000-$99,000",
                      income_lvl.lab %in% c("$100,000 - $124,999", "$125,000 - $149,999", "$150,000 or more") ~ "â‰¥$100,000",
                      income_lvl.lab == "Missing" ~ "Missing")
            ))

phenos_basic.df %>% reframe(Income_lvl=n_pct(income_lvl.lab))
phenos_basic.df %>% reframe(Income_4lvl=n_pct(income_4lvl.lab))
```

Add income:poverty ratio for 2010-2011
```{r}
#Resource: https://aspe.hhs.gov/topics/poverty-economic-mobility/poverty-guidelines/prior-hhs-poverty-guidelines-federal-register-references

income_lvls <- phenos_basic.df %>% reframe(lvls=n_pct(income_lvl.lab)) 
income_lvls$num <- c(median(c(0,5000)), median(c(5000, 7999)), median(c(8000, 11999)), median(c(12000,15999)), 
                            median(c(16000,19999)), median(c(20000,24999)), median(c(25000,29999)), 
                            median(c(30000,34999)), median(c(35000,39999)), median(c(40000, 49999)), 
                            median(c(50000, 74999)), median(c(75000, 99999)), median(c(100000, 124999)), median(c(125000, 149000)),
                            150000, NA)

income_lvls

phenos_basic.df <- phenos_basic.df %>% mutate(
    income_num=case_when(income_lvl.lab == income_lvls[1,1] ~ income_lvls[1,2],
                         income_lvl.lab == income_lvls[2,1] ~ income_lvls[2,2],
                         income_lvl.lab == income_lvls[3,1] ~ income_lvls[3,2],
                         income_lvl.lab == income_lvls[4,1] ~ income_lvls[4,2],
                        income_lvl.lab == income_lvls[5,1] ~ income_lvls[5,2],
                        income_lvl.lab == income_lvls[6,1] ~ income_lvls[6,2],
                        income_lvl.lab == income_lvls[7,1] ~ income_lvls[7,2],
                        income_lvl.lab == income_lvls[8,1] ~ income_lvls[8,2],
                        income_lvl.lab == income_lvls[9,1] ~ income_lvls[9,2],
                        income_lvl.lab == income_lvls[10,1] ~ income_lvls[10,2],
                        income_lvl.lab == income_lvls[11,1] ~ income_lvls[11,2],
                        income_lvl.lab == income_lvls[12,1] ~ income_lvls[12,2],
                        income_lvl.lab == income_lvls[13,1] ~ income_lvls[13,2],
                        income_lvl.lab == income_lvls[14,1] ~ income_lvls[14,2],
                        income_lvl.lab == income_lvls[15,1] ~ income_lvls[15,2],
                        income_lvl.lab == income_lvls[16,1] ~ income_lvls[16,2],
                        ) ) %>% mutate(
    income2poverty2011 = ifelse(income_hhld == 1, income_num / 10830, (income_num / (10830 + 3740*(income_hhld-1)))) )

   
```

Recode smoking & alch vars
```{r}
phenos_basic.df <- phenos_basic.df %>%
    mutate(smoke_stat.lab = ifelse(is.na(smoke_stat), "Missing", smoke_stat)) %>%
    mutate(
        factor(smoke_stat, levels = c("current smoker", "former smoker, quit less than one year",
                                      "former smoker quit more than 1 year ago", "never smoked", "do not know"),
        labels = c("Current", "Former, <1 yr", "Former, >1 yr", "Never", "Missing"))
           ) %>%
    mutate(alch_currdrnk.lab = ifelse(is.na(alch_currdrnk), "Missing", alch_currdrnk)) %>%
    mutate(alch_currdrnk.lab = factor(alch_currdrnk, levels = c("no", "yes", "Missing"), 
                                      labels = c("Non-drinker", "Drinker", "Missing")))
                                   

phenos_basic.df %>% reframe(smoke=n_pct(smoke_stat.lab))
phenos_basic.df %>% reframe(current_drinker=n_pct(alch_currdrnk.lab))
```

Recode medication variables as 0/1
```{r}
phenos_basic.df <- phenos_basic.df %>%
    mutate(med_t2d = factor(ifelse(med_t2d == "no" | is.na(med_t2d), 0, 1)),
           med_htn = factor(ifelse(med_htn == "yes", 1, 0)),
           med_lip = factor(ifelse(med_lip == "yes", 1, 0)))
phenos_basic.df %>% reframe(med_t2d=n_pct(med_t2d))
```


## Basic diet phenotypes
```{r}
# Basic diet phenotypes
phenos_diet.df <- read_csv("phenotypes/mesa5_phenos_diet.csv", col_types=cols()) %>%
    rename_with(fix_pheno_names, everything()) %>%
    mutate(mesa_id = gsub("phs000209.v13_", "", 
                          `\\_Parent Study Accession with Subject ID\\`),
           mesa_id = as.integer(mesa_id)) %>%
    rename(Parent_Study_Accession='\\_Parent Study Accession with Subject ID\\',
           TopMed_Study_Accesssion='\\_Topmed Study Accession with Subject ID\\',
           consents='\\_consents\\') %>%
    select(-c(Parent_Study_Accession, TopMed_Study_Accesssion, consents, 'Patient ID')) %>%

    rename(energy_kcal=enrgyn5c,
           nut_carb_g=tcarbn5c,
           nut_prot_g=tprtnn5c,
           nut_fat_g=tfatn5c,
           nut_sfa_g=tsfan5c,
           nut_mufa_g=tmufan5c,
           nut_pufa_g=tpufan5c,
           nut_fiber_g=tfibrn5c,
           nut_fiber_sol_g=sfibrn5c,
           nut_fiber_insol_g=isfbrn5c,
           nut_fiber_cereal_g=cerealdf5c,
           nut_fat_pct=pclftn5c,
           nut_carb_pct=pclcbn5c,
           nut_prot_pct=pcprtn5c,
           nut_sfa_pct=pclsfn5c,
           nut_mufa_pct=pclmfn5c,
           nut_pufa_pct=pclpfn5c,
           nut_alch_g=alcn5c) %>%

    mutate(across(c(energy_kcal, nut_carb_g, nut_fat_g, nut_prot_g), remove_outliers.fun)) %>%
    mutate(carb2fib = case_when(
                nut_carb_g != 0 & nut_fiber_g != 0 ~ nut_carb_g / nut_fiber_g,
                !is.na(nut_carb_g) & nut_fiber_g == 0 ~ 0,
                is.na(nut_carb_g) | is.na(nut_fiber_g) ~ NA),
           fib2carb = case_when(
                nut_carb_g != 0 & nut_fiber_g != 0 ~ nut_fiber_g / nut_carb_g,
                !is.na(nut_carb_g) & nut_fiber_g == 0 ~ 0,
                is.na(nut_fiber_g) | is.na(nut_carb_g) ~ NA)
          ) %>%
    as.data.frame()

head(phenos_diet.df)
```
