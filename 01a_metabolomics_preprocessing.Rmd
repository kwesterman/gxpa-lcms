```{r, echo=F}
library(data.table)
library(matrixStats)

ws_bucket <- "gs://fc-secure-4a392455-5587-4d6f-b8bd-01a1f834ae63"
if(!file.exists("metabolomics/raw")) system(paste0("gsutil -m cp -r ",ws_bucket,"/metabolomics/raw .")) 

dir.create("metabolomics/cleaned",showWarnings=F)
dir.create("metabolomics/QCd",    showWarnings=F)
```

# Inspect data
There are files for 3 LC-MS methods: C8-positive, HILIC-positive, and Amines ([descriptions here](https://topmed.nhlbi.nih.gov/sites/default/files/TOPMed_CORE_Year3_Broad-BIDMC_metabolomics_methods.pdf)).
```{r results="asis"}
data_files <- list(C8="metabolomics/raw/MESA_pilot_BroadInst_C8-pos_lipids_050517.csv", # C8-positive
                   HP="metabolomics/raw/MESA_pilot_BroadInst_HIL-pos_polar_050517.csv", # HILIC-positive
                   AN="metabolomics/raw/an_MESA_clean.txt")                             # Amines

quick_look <- \(file) knitr::kable(fread(file, nrow=8, select=1:8))
lapply(data_files, quick_look)
```
Nonstandard format, so prepare for hardcoded row/col numbers!


# Extract sample metadata
Note: MESA AN file has no sample metadata, but all its sample IDs are covered by C8 and HP methods anyways.
```{r}
sample_info <- list()
sample_info$C8 <- fread(data_files$C8, nrow=5, drop=1:5) |> transpose()
sample_info$HP <- fread(data_files$HP, nrow=5, drop=1:5) |> transpose()
names(sample_info[[1]]) <- names(sample_info[[2]]) <- c("extr_date","inject_date","column","analysis_order","sample_id")

sample_info <- merge(sample_info$C8, sample_info$HP, by="sample_id", suffixes=c("_c8","_hp"), all=T)

# Rm all-NA rows, an artifact from the C8 file
sample_info <- sample_info[rowSums(!is.na(sample_info)) > 0]

sample_info[, is_qc_sample := !grepl("TOM",sample_id)]

fwrite(sample_info, "metabolomics/sample_info.csv")
knitr::kable(head(sample_info))


```
# Extract metabolite metadata
Compound IDs may be duplicated across C8 and HP. A concatenated `<ID>_<Method>` variable ensures IDs are unique.\
Then, create a file mapping these IDs back to their metabolite metadata such as M/Z and RT.
```{r}
met_info <- list()
met_info$C8 <- fread(data_files$C8, skip=4, select=1:6)
met_info$HP <- fread(data_files$HP, skip=4, select=1:6)
met_info$AN <- data.table(method="Amine", compound_id=NA, mz=NA, rt=NA, hmdb_id=NA,
                          name=names(fread(data_files$AN,nrow=0))[-1])
names(met_info$C8) <- names(met_info$HP) <- names(met_info$AN)
met_info <- rbindlist(met_info)

met_info[met_info=='' | met_info=='n/a'] <- NA

met_info[,                unique_met_id := paste0(compound_id,"_",method)]
met_info[method=="Amine", unique_met_id := name                          ] # Amines have no compound ID so just use name
#sum(duplicated(met_info$unique_id)) # No dup IDs!

fwrite(met_info, "metabolomics/met_info.csv")
knitr::kable(head(met_info))
```


# Extract measurement data
```{r, results="hide", warning=F, message=F}
data <- list()
data$C8 <- fread(data_files$C8, skip=4, drop=1:6, colClasses="double") |> t() |> `colnames<-`(met_info[method== "C8-pos",unique_met_id]) # Yes I double-checked, the names are in the proper order
data$HP <- fread(data_files$HP, skip=4, drop=1:6, colClasses="double") |> t() |> `colnames<-`(met_info[method=="HIL-pos",unique_met_id])
data$AN <- fread(data_files$AN)                                        |> as.matrix(rownames=1)
class(data$C8) <- class(data$HP) <- class(data$AN) <- "numeric" # "NAs introduced by coersion" are due to 2 weird cells in AN: "1+2559:2584.03935869994933" and "5+3828:3930.95273887971489"

data$C8 <- data$C8[rowSums(!is.na(data$C8)) > 0,] # Rm all-NA rows artifact in the C8 file
data$AN[data$AN<0] <- NA # Amines has 2 negative measurements, which doesn't make sense

mapply(fwrite, data, paste0("metabolomics/cleaned/",names(data),"_cleaned.csv"), row.names=T)
```
```{r results="hold"}
data$C8[1:4,1:4] # Check out the cleaned data!
data$HP[1:4,1:4]
data$AN[1:4,1:4]
```


# QC
1\. Remove signatures w/ variance = 0\
2\. Remove signatures w/ >25% missingness\
3\. Half-min Impute\
4\. Winsorize to 5*sd\
5\. Log2\
Missingness removal is done in two separate steps, where high-missingness metabolites are removed first, _then_ samples (to prioritize not losing samples).\
Batch adjustment is best done at the same time as adjusting for other covariates, later.
```{r results="hide", message=F}
winsorizeColsBySd <- \(m, n_sd) {
  cmeans <- colMeans(m,na.rm=T)
  csds   <- colSds  (m,na.rm=T)
  lower <- cmeans - n_sd*csds
  upper <- cmeans + n_sd*csds
  t(pmin(pmax(t(m),lower),upper)) # lower/upper are vectors of length ncol(m), recycled for each row of the matrix.
}

data <- lapply(data, \(m) {
  m <- m[, colVars(m) > 0] # step 1
  m <- m[,colSums(is.na(m)) < 0.25*nrow(m) ] # step 2a
  m <- m[ rowSums(is.na(m)) < 0.25*nrow(m),] # step 2b
  m[is.na(m)] <- (colMins(m,na.rm=T)/2)[col(m)[is.na(m)]] # step 3
  m <- winsorizeColsBySd(m,5) # step 4
  m <- log2(m+1) # step 5
})

mapply(fwrite, data, paste0("metabolomics/QCd/",names(data),"_QCd_log2.csv"), row.names=T)
```


# Plots
## Distribution of metabolite medians
```{r results="hide", fig.width=12}
histColMedians <- function(df, title) { hist(colMedians(df), main=title) }

par(mfrow=c(1,3))
mapply(histColMedians, data, names(data))
```

## Skew vs. Kurtosis
```{r, results="hide", fig.width=12}
plotSkewKurt <- function(df, title) {
  n <- nrow(df); ms <- colMeans(df); sds <- colSds(df)
  skews <- sapply(1:ncol(df),\(col) (sum((df[,col]-ms[col])^3)/sds[col]^3)/n   )
  kurts <- sapply(1:ncol(df),\(col) (sum((df[,col]-ms[col])^4)/sds[col]^4)/n-3 )
  sk <- data.frame(skews=skews, kurts=kurts)

  {plot(sk$skews, sk$kurts, pch = 16, cex = 0.5, main = title, 
    xlab = "Skews", ylab = "Kurts", col = "black") +
   abline(v = -0.5, lty = 2,  lwd = 2) + 
   abline(v =  0.5, lty = 2,  lwd = 2) +
   abline(h = -2.0, lty = 2,  lwd = 2) +
   abline(h =  2.0, lty = 2,  lwd = 2)}
}

par(mfrow=c(1,3))
mapply(plotSkewKurt, data, names(data))
```

## Individual metabolite distributions
You may need to zoom in all the way, and use Windows Magnifier (Win+"+" keys) to see.
```{r results="hide", cache=T}
plotAllMets <- function(mtx) {
  par(mar=c(.1,.1,.4,.1), oma=rep(0,4), xaxt='n', yaxt='n', lwd=0.1,
      mfrow = c(ceiling(ncol(mtx)/30), 30)
  )
  sapply(1:ncol(mtx), FUN = \(i)
    plot(mtx[,i], main=colnames(mtx)[i], cex.main=0.5,
         pch=16, col=rgb(0,0,0,0.8), cex=0.1)
  )
}

png("met_dists_C8.png", width = 8000, height = 16000, res=600)
plotAllMets(data$C8)
dev.off()
png("met_dists_HP.png", width = 8000, height = 16000, res=600)
plotAllMets(data$HP)
dev.off()
png("met_dists_AN.png", width = 8000, height = 800, res=600)
plotAllMets(data$AN)
dev.off()
```

![](met_dists_C8.png)

![](met_dists_HP.png)

![](met_dists_AN.png)
